<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - MindMitra</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-heart"></i>
                <span>MindMitra</span>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/resources" class="nav-link">Resources</a>
                <a href="/journal" class="nav-link">Journal</a>
                <a href="/forum" class="nav-link">Forum</a>
                <a href="/mood" class="nav-link">Mood Tracker</a>
                <a href="/chat" class="nav-link">Chat</a>
                <a href="/profile" class="nav-link active">Profile</a>
            </div>
            <div class="nav-user" id="nav-user" style="display: none;">
                <img id="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="User Avatar" class="user-avatar">
                <span id="user-name">User</span>
                <button id="logout-btn" class="btn btn-outline btn-small">Logout</button>
            </div>
            <div class="auth-buttons" id="auth-buttons">
                <a href="/login" class="btn btn-outline">Login</a>
                <a href="/signup" class="btn btn-primary">Sign Up</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <div class="container">
                <h1><i class="fas fa-user"></i> My Profile</h1>
                <p>Manage your account settings and preferences</p>
            </div>
        </div>

        <section class="profile-section">
            <div class="container">
                <div class="profile-grid">
                    <!-- Profile Info Card -->
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar-container">
                                <img id="profile-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Profile Avatar" class="profile-avatar">
                                <button id="change-avatar-btn" class="avatar-change-btn">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                            <div class="profile-info">
                                <h2 id="profile-name">User Name</h2>
                                <p id="profile-role" class="profile-role">Student</p>
                                <p id="profile-email" class="profile-email">user@example.com</p>
                            </div>
                        </div>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="journal-count">0</div>
                                <div class="stat-label">Journal Entries</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="mood-count">0</div>
                                <div class="stat-label">Mood Entries</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="forum-count">0</div>
                                <div class="stat-label">Forum Posts</div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="profile-card">
                        <h3>Edit Profile</h3>
                        <form id="profile-form">
                            <div class="form-group">
                                <label for="edit-name">Full Name</label>
                                <input type="text" id="edit-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-email">Email Address</label>
                                <input type="email" id="edit-email" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-bio">Bio</label>
                                <textarea id="edit-bio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-location">Location</label>
                                <input type="text" id="edit-location" placeholder="City, Country">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-phone">Phone Number</label>
                                <input type="tel" id="edit-phone" placeholder="+1 (555) 123-4567">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>

                    <!-- Privacy Settings -->
                    <div class="profile-card">
                        <h3>Privacy Settings</h3>
                        <div class="privacy-settings">
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="profile-visibility">
                                    <span class="setting-text">Make my profile visible to other users</span>
                                </label>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="email-notifications">
                                    <span class="setting-text">Receive email notifications</span>
                                </label>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="chat-notifications">
                                    <span class="setting-text">Receive chat notifications</span>
                                </label>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="anonymous-posts">
                                    <span class="setting-text">Post anonymously by default</span>
                                </label>
                            </div>
                        </div>
                        
                        <button id="save-privacy" class="btn btn-primary">
                            <i class="fas fa-shield-alt"></i> Save Privacy Settings
                        </button>
                    </div>

                    <!-- Change Password -->
                    <div class="profile-card">
                        <h3>Change Password</h3>
                        <form id="password-form">
                            <div class="form-group">
                                <label for="current-password">Current Password</label>
                                <input type="password" id="current-password" required autocomplete="current-password">
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" required autocomplete="new-password">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" required autocomplete="new-password">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </form>
                    </div>

                    <!-- Account Actions -->
                    <div class="profile-card">
                        <h3>Account Actions</h3>
                        <div class="account-actions">
                            <button id="export-data" class="btn btn-outline">
                                <i class="fas fa-download"></i> Export My Data
                            </button>
                            
                            <button id="delete-account" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Avatar Upload Modal -->
    <div id="avatar-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Profile Picture</h2>
                <button id="close-avatar-modal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avatar-upload">
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload or drag and drop</p>
                        <p class="upload-hint">PNG, JPG up to 5MB</p>
                    </div>
                    <div class="avatar-preview" id="avatar-preview" style="display: none;">
                        <img id="preview-image" src="" alt="Preview">
                        <button id="upload-avatar" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Avatar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script src="/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadProfileData();
            
            // Event listeners
            document.getElementById('profile-form').addEventListener('submit', updateProfile);
            document.getElementById('password-form').addEventListener('submit', changePassword);
            document.getElementById('save-privacy').addEventListener('click', savePrivacySettings);
            document.getElementById('change-avatar-btn').addEventListener('click', openAvatarModal);
            document.getElementById('close-avatar-modal').addEventListener('click', closeAvatarModal);
            document.getElementById('avatar-input').addEventListener('change', handleAvatarSelect);
            document.getElementById('upload-area').addEventListener('click', () => document.getElementById('avatar-input').click());
            document.getElementById('upload-avatar').addEventListener('click', uploadAvatar);
            document.getElementById('export-data').addEventListener('click', exportUserData);
            document.getElementById('delete-account').addEventListener('click', deleteAccount);
        });

        function loadProfileData() {
            fetch('/api/auth/profile', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateProfileData(data.user);
                    loadProfileStats();
                }
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
        }

        function populateProfileData(user) {
            document.getElementById('profile-name').textContent = user.name;
            document.getElementById('profile-role').textContent = user.role;
            document.getElementById('profile-email').textContent = user.email;
            
            if (user.profile?.avatar) {
                document.getElementById('profile-avatar').src = user.profile.avatar;
            }
            
            // Populate form fields
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-bio').value = user.profile?.bio || '';
            document.getElementById('edit-location').value = user.profile?.location || '';
            document.getElementById('edit-phone').value = user.profile?.phone || '';
            
            // Populate privacy settings
            document.getElementById('profile-visibility').checked = user.profile?.visibility !== false;
            document.getElementById('email-notifications').checked = user.profile?.emailNotifications !== false;
            document.getElementById('chat-notifications').checked = user.profile?.chatNotifications !== false;
            document.getElementById('anonymous-posts').checked = user.profile?.anonymousPosts === true;
        }

        function loadProfileStats() {
            // Load journal count
            fetch('/api/journal/count', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('journal-count').textContent = data.count;
                }
            });
            
            // Load mood count
            fetch('/api/mood/count', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('mood-count').textContent = data.count;
                }
            });
            
            // Load forum count
            fetch('/api/forum/count', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('forum-count').textContent = data.count;
                }
            });
        }

        function updateProfile(e) {
            e.preventDefault();
            
            const profileData = {
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                profile: {
                    bio: document.getElementById('edit-bio').value,
                    location: document.getElementById('edit-location').value,
                    phone: document.getElementById('edit-phone').value
                }
            };
            
            fetch('/api/auth/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(profileData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully!');
                    loadProfileData();
                } else {
                    alert('Failed to update profile. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            });
        }

        function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long.');
                return;
            }
            
            fetch('/api/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ currentPassword, newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    document.getElementById('password-form').reset();
                } else {
                    alert(data.message || 'Failed to change password.');
                }
            })
            .catch(error => {
                console.error('Error changing password:', error);
                alert('Failed to change password. Please try again.');
            });
        }

        function savePrivacySettings() {
            const settings = {
                visibility: document.getElementById('profile-visibility').checked,
                emailNotifications: document.getElementById('email-notifications').checked,
                chatNotifications: document.getElementById('chat-notifications').checked,
                anonymousPosts: document.getElementById('anonymous-posts').checked
            };
            
            fetch('/api/auth/privacy', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Privacy settings saved successfully!');
                } else {
                    alert('Failed to save privacy settings.');
                }
            })
            .catch(error => {
                console.error('Error saving privacy settings:', error);
                alert('Failed to save privacy settings.');
            });
        }

        function openAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'flex';
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
            document.getElementById('avatar-preview').style.display = 'none';
            document.getElementById('upload-area').style.display = 'block';
        }

        function handleAvatarSelect(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('upload-area').style.display = 'none';
                    document.getElementById('avatar-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function uploadAvatar() {
            const fileInput = document.getElementById('avatar-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('avatar', file);
            
            fetch('/api/auth/avatar', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Avatar updated successfully!');
                    document.getElementById('profile-avatar').src = data.avatarUrl;
                    closeAvatarModal();
                } else {
                    alert('Failed to upload avatar.');
                }
            })
            .catch(error => {
                console.error('Error uploading avatar:', error);
                alert('Failed to upload avatar.');
            });
        }

        function exportUserData() {
            if (confirm('This will download all your data. Continue?')) {
                fetch('/api/auth/export', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mindmitra-data.json';
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error exporting data:', error);
                    alert('Failed to export data.');
                });
            }
        }

        function deleteAccount() {
            const confirmation = prompt('This action cannot be undone. Type "DELETE" to confirm:');
            if (confirmation === 'DELETE') {
                fetch('/api/auth/delete', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Account deleted successfully.');
                        localStorage.removeItem('token');
                        window.location.href = '/';
                    } else {
                        alert('Failed to delete account.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account.');
                });
            }
        }
    </script>
</body>
</html>
